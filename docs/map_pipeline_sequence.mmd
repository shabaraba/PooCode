sequenceDiagram
    %% ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ‘ãƒ³ãƒˆå®šç¾©
    participant User as ãƒ¦ãƒ¼ã‚¶ãƒ¼
    participant Runtime as å®Ÿè¡Œãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
    participant Lexer as å­—å¥è§£æå™¨
    participant Parser as æ§‹æ–‡è§£æå™¨
    participant AST as æŠ½è±¡æ§‹æ–‡æœ¨
    participant Evaluator as è©•ä¾¡å™¨
    participant Environment as ç’°å¢ƒ

    %% ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Ÿè¡Œé–‹å§‹
    User->>Runtime: ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Ÿè¡Œï¼ˆmapãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å«ã‚€ï¼‰
    Runtime->>Lexer: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰è§£æä¾é ¼
    
    %% å­—å¥è§£æãƒ—ãƒ­ã‚»ã‚¹
    Lexer->>Lexer: ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«åˆ†å‰²
    Note over Lexer: ç‰¹æ®Šãƒˆãƒ¼ã‚¯ãƒ³ `|>`, `map/` ã®æ¤œå‡º
    Lexer-->>Parser: ãƒˆãƒ¼ã‚¯ãƒ³åˆ—ã‚’æ¸¡ã™
    
    %% æ§‹æ–‡è§£æãƒ—ãƒ­ã‚»ã‚¹
    Parser->>Parser: ãƒ—ãƒ­ã‚°ãƒ©ãƒ ãƒãƒ¼ãƒ‰ä½œæˆ
    
    %% ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æ–‡ã®è§£æ
    Parser->>Parser: parsePipeStatement()
    Parser->>Parser: å·¦è¾ºå¼ï¼ˆå…¥åŠ›ï¼‰ã®è§£æ
    
    %% mapãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®è§£æ
    Parser->>Parser: 'map/' ãƒˆãƒ¼ã‚¯ãƒ³æ¤œå‡º
    Parser->>Parser: parseMapFilter() 
    Parser->>Parser: å¤‰æ›é–¢æ•°ã®è§£æ
    
    %% ASTæ§‹ç¯‰å®Œäº†
    Parser-->>AST: å®Œæˆã—ãŸAST
    AST-->>Runtime: æ§‹æ–‡è§£æå®Œäº†
    
    %% è©•ä¾¡ãƒ—ãƒ­ã‚»ã‚¹é–‹å§‹
    Runtime->>Evaluator: è©•ä¾¡é–‹å§‹
    
    %% ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å…¥åŠ›ã®è©•ä¾¡
    Evaluator->>Evaluator: evalPipeStatement()
    Evaluator->>Evaluator: å·¦è¾ºå¼ã‚’è©•ä¾¡ï¼ˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    
    %% mapãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®è©•ä¾¡
    Evaluator->>Evaluator: evalMapFilterStatement()
    Note over Evaluator: ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒé…åˆ—ã¾ãŸã¯æ–‡å­—åˆ—ã‹ç¢ºèª
    
    %% mapã®å‡¦ç†ï¼ˆã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹ï¼‰
    Evaluator->>Evaluator: å„è¦ç´ ã«å¯¾ã—ã¦ç¹°ã‚Šè¿”ã—å‡¦ç†é–‹å§‹
    
    loop ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®å„è¦ç´ ã«å¯¾ã—ã¦
        %% æ–°ã—ã„ç’°å¢ƒã‚’ä½œæˆ
        Evaluator->>Environment: æ–°ã—ã„ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚³ãƒ¼ãƒ—ä½œæˆ
        Environment-->>Evaluator: ã‚¤ãƒ†ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç’°å¢ƒ
        
        %% ç¾åœ¨ã®è¦ç´ ã‚’ğŸ•ã«è¨­å®š
        Evaluator->>Environment: ç¾åœ¨ã®è¦ç´ ã‚’ğŸ•ã«è¨­å®š
        
        %% å¤‰æ›é–¢æ•°ã‚’è©•ä¾¡
        Evaluator->>Evaluator: å¤‰æ›é–¢æ•°ã‚’ç¾åœ¨ã®è¦ç´ ã«é©ç”¨
        Evaluator->>Evaluator: çµæœã‚’å–å¾—ï¼ˆğŸ’©ã®å€¤ï¼‰
        
        %% çµæœã‚’æ–°ã—ã„é…åˆ—ã«è¿½åŠ 
        Evaluator->>Evaluator: çµæœã‚’å‡ºåŠ›é…åˆ—ã«è¿½åŠ 
    end
    
    %% å¤‰æ›çµæœã‚’è¿”å´
    Evaluator-->>Runtime: å¤‰æ›æ¸ˆã¿ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³
    
    %% æ¬¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ãŒã‚ã‚Œã°ç¶™ç¶š
    alt æ¬¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã‚ã‚Š
        Note over Runtime, Evaluator: æ¬¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¤‰æ›çµæœã‚’æ¸¡ã™
        Runtime->>Evaluator: æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã‚’è©•ä¾¡ï¼ˆçµæœã‚’å…¥åŠ›ã¨ã—ã¦ï¼‰
        Evaluator-->>Runtime: æœ€çµ‚çµæœ
    else ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ‚äº†
        Runtime-->>User: å‡¦ç†çµæœè¡¨ç¤º
    end