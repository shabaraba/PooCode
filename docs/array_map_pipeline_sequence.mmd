sequenceDiagram
    %% ã‚·ãƒ¼ã‚±ãƒ³ã‚¹å›³ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚·ãƒ‘ãƒ³ãƒˆå®šç¾©
    participant Runtime as å®Ÿè¡Œãƒ©ãƒ³ã‚¿ã‚¤ãƒ 
    participant Evaluator as è©•ä¾¡å™¨
    participant Env as ç’°å¢ƒ
    participant Stage1 as ã‚¹ãƒ†ãƒ¼ã‚¸1<br>(é…åˆ—ã‚’è¿”ã™)
    participant MapPipe as mapãƒ‘ã‚¤ãƒ—å‡¦ç†
    participant Stage2 as ã‚¹ãƒ†ãƒ¼ã‚¸2<br>(å„è¦ç´ ã«é©ç”¨)

    %% ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©•ä¾¡é–‹å§‹
    Note over Runtime: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©•ä¾¡é–‹å§‹<br>(ä¾‹: data |> stage1 |> map/stage2)
    Runtime->>Evaluator: ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©•ä¾¡ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    
    %% åˆæœŸãƒ‡ãƒ¼ã‚¿ã®è©•ä¾¡
    Evaluator->>Evaluator: evalPipeStatement()
    Evaluator->>Evaluator: åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’è©•ä¾¡
    Evaluator-->>Evaluator: åˆæœŸãƒ‡ãƒ¼ã‚¿ã®å€¤
    
    %% ã‚¹ãƒ†ãƒ¼ã‚¸1ã®å‡¦ç† (é…åˆ—ã‚’è¿”ã™)
    Evaluator->>Stage1: ã‚¹ãƒ†ãƒ¼ã‚¸1ã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™
    
    %% ã‚¹ãƒ†ãƒ¼ã‚¸1ã®è©•ä¾¡ç’°å¢ƒæº–å‚™
    Evaluator->>Env: æ–°ã—ã„ã‚¹ãƒ†ãƒ¼ã‚¸1ç’°å¢ƒä½œæˆ
    Env-->>Evaluator: ã‚¹ãƒ†ãƒ¼ã‚¸1ã®ç’°å¢ƒ
    
    %% ã‚¹ãƒ†ãƒ¼ã‚¸1ã®å…¥åŠ›è¨­å®š
    Evaluator->>Env: ğŸ•ã«åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    Note over Env: ç’°å¢ƒå†…: ğŸ• = åˆæœŸãƒ‡ãƒ¼ã‚¿
    
    %% ã‚¹ãƒ†ãƒ¼ã‚¸1ã®è©•ä¾¡ (é…åˆ—ã‚’è¿”ã™)
    Evaluator->>Stage1: é–¢æ•°å‡¦ç†å®Ÿè¡Œ
    Stage1->>Env: ğŸ’©ã«é…åˆ—çµæœã‚’æ ¼ç´
    Env-->>Stage1: æ ¼ç´å®Œäº†
    Stage1-->>Evaluator: é…åˆ—çµæœ
    
    %% mapãƒ‘ã‚¤ãƒ—ã®æ¤œå‡ºã¨å‡¦ç†é–‹å§‹
    Note over Evaluator: mapãƒ‘ã‚¤ãƒ—æ¼”ç®—å­ (map/) ã‚’æ¤œå‡º
    Evaluator->>MapPipe: é…åˆ—ã¨é–¢æ•°ã‚’æ¸¡ã—ã¦å‡¦ç†é–‹å§‹
    
    %% mapãƒ‘ã‚¤ãƒ—å‡¦ç†ã®æº–å‚™
    MapPipe->>MapPipe: evalMapFilterStatement()
    MapPipe->>MapPipe: å…¥åŠ›ãŒé…åˆ—ã‹ç¢ºèª
    
    %% é…åˆ—ã®å„è¦ç´ ã«å¯¾ã™ã‚‹ç¹°ã‚Šè¿”ã—å‡¦ç†
    loop é…åˆ—ã®å„è¦ç´ ã«å¯¾ã—ã¦
        %% è¦ç´ ã”ã¨ã®ç’°å¢ƒä½œæˆ
        MapPipe->>Env: è¦ç´ ã”ã¨ã®æ–°ç’°å¢ƒä½œæˆ
        Env-->>MapPipe: è¦ç´ ç”¨ç’°å¢ƒ
        
        %% ç¾åœ¨ã®è¦ç´ ã‚’ğŸ•ã«è¨­å®š
        MapPipe->>Env: ğŸ•ã«ç¾åœ¨ã®é…åˆ—è¦ç´ ã‚’è¨­å®š
        Note over Env: ç’°å¢ƒå†…: ğŸ• = é…åˆ—[i]
        
        %% ã‚¹ãƒ†ãƒ¼ã‚¸2ã®å‡¦ç†ã‚’å„è¦ç´ ã«é©ç”¨
        MapPipe->>Stage2: è¦ç´ ã«å¯¾ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¸2ã‚’å®Ÿè¡Œ
        Stage2->>Env: ğŸ’©ã«å¤‰æ›çµæœã‚’æ ¼ç´
        Env-->>Stage2: æ ¼ç´å®Œäº†
        Stage2-->>MapPipe: è¦ç´ ã®å¤‰æ›çµæœ
        
        %% å¤‰æ›çµæœã‚’å‡ºåŠ›é…åˆ—ã«è¿½åŠ 
        MapPipe->>MapPipe: å‡ºåŠ›é…åˆ—ã«çµæœã‚’è¿½åŠ 
    end
    
    %% mapãƒ‘ã‚¤ãƒ—ã®å‡¦ç†å®Œäº†ã€çµæœé…åˆ—ã®è¿”å´
    MapPipe-->>Evaluator: å¤‰æ›æ¸ˆã¿é…åˆ—
    
    %% æ¬¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ãŒã‚ã‚Œã°ç¶™ç¶š
    alt æ¬¡ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸ã‚ã‚Š
        Note over Evaluator: æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸ã«å¤‰æ›æ¸ˆã¿é…åˆ—ã‚’æ¸¡ã™
        Evaluator->>Evaluator: æ¬¡ã®ã‚¹ãƒ†ãƒ¼ã‚¸è©•ä¾¡
    else ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³çµ‚äº†
        Evaluator-->>Runtime: æœ€çµ‚çµæœé…åˆ—
    end
    
    %% ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æˆ»ã‚Šå€¤ã®ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹èª¬æ˜
    Note over Runtime: å¤‰æ›å¾Œã®é…åˆ—ãŒæœ€çµ‚çµæœ<br>- å„è¦ç´ ãŒã‚¹ãƒ†ãƒ¼ã‚¸2ã§å¤‰æ›ã•ã‚ŒãŸ<br>- çµæœã¯å…ƒé…åˆ—ã¨åŒã˜é•·ã•ã«ãªã‚‹